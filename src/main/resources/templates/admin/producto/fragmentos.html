<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <body>

    <!-- Barra superior con botones -->
    <div th:fragment="toolbarProductos()">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Gestión de Productos</h1>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary" th:href="@{/admin/categoria/listado}">
            <i class="bi bi-tags"></i> Categorías
          </a>
          <a class="btn btn-success" th:href="@{/admin/producto/nuevo}">
            <i class="bi bi-plus-lg"></i> Añadir Producto
          </a>
        </div>
      </div>
    </div>

    <!-- Filtros (recibe categorias, filtroNombre, filtroCategoria) -->
    <div th:fragment="filtroProductos(categorias, filtroNombre, filtroCategoria)">
      <form class="row g-2 align-items-end mb-3" th:action="@{/admin/producto/listado}" method="get">
        <div class="col-md-4">
          <label class="form-label">Buscar</label>
          <input class="form-control" type="search" name="q" placeholder="Nombre..." th:value="${filtroNombre}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Categoría</label>
          <select class="form-select" name="idCategoria">
            <option value="" th:selected="${filtroCategoria} == null">Todas</option>
            <option th:each="c : ${categorias}"
                    th:value="${c.idCategoria}"
                    th:selected="${filtroCategoria} == ${c.idCategoria}"
                    th:text="${c.nombre}">Cat</option>
          </select>
        </div>
        <div class="col-md-4">
          <button class="btn btn-outline-secondary me-2">Filtrar</button>
          <a class="btn btn-outline-dark" th:href="@{/admin/producto/listado}">Limpiar</a>
        </div>
      </form>
    </div>

    <!-- Tabla (recibe productos y _csrf) -->
    <div th:fragment="tablaProductos(productos, _csrf)">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:60px">ID</th>
              <th style="width:80px">Imagen</th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th class="text-end">Precio</th>
              <th class="text-end">Stock</th>
              <th style="width:210px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="p : ${productos}">
              <td th:text="${p.idProducto}">1</td>
              <td>
                <img th:if="${p.rutaImagen != null}" th:src="${p.rutaImagen}" alt=""
                     style="height:48px;width:48px;object-fit:cover;border-radius:8px">
                <div th:if="${p.rutaImagen == null}" class="bg-light border rounded" style="height:48px;width:48px"></div>
              </td>
              <td th:text="${p.nombre}">Nombre</td>
              <td th:text="${p.categoria != null ? p.categoria.nombre : '—'}">Categoría</td>
              <td class="text-end">₡ <span th:text="${#numbers.formatDecimal(p.precio,1,'COMMA',2,'POINT')}">0.00</span></td>
              <td class="text-end" th:text="${p.stock}">0</td>
              <td>
                <a class="btn btn-sm btn-primary" th:href="@{'/admin/producto/modificar/' + ${p.idProducto}}">
                  <i class="bi bi-pencil-square"></i> Editar
                </a>
                <form th:action="@{'/admin/producto/eliminar/' + ${p.idProducto}}" method="post" class="d-inline">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar este producto?');">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Formulario (recibe producto, categorias, _csrf) -->
    <section th:fragment="formProducto(producto, categorias, _csrf)">
      <form th:action="@{/admin/producto/guardar}" method="post" enctype="multipart/form-data"
            th:object="${producto}" class="row g-3">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" th:field="*{idProducto}"/>
        <input type="hidden" th:field="*{rutaImagen}"/>

        <div class="col-md-6">
          <label class="form-label">Nombre</label>
          <input class="form-control" th:field="*{nombre}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}"></div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Precio</label>
          <input type="number" step="0.01" class="form-control" th:field="*{precio}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('precio')}" th:errors="*{precio}"></div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Stock</label>
          <input type="number" class="form-control" th:field="*{stock}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}"></div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Categoría</label>
          <!-- El binder creará categoria si es null -->
          <select class="form-select" th:field="*{categoria.idCategoria}">
            <option th:each="c : ${categorias}" th:value="${c.idCategoria}" th:text="${c.nombre}">Cat</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Imagen</label>
          <input type="file" class="form-control" name="imagenFile" accept="image/*">
          <div class="form-text" th:if="${producto.rutaImagen != null}">
            Imagen actual:
            <img th:src="${producto.rutaImagen}" alt="" style="height:48px;width:48px;object-fit:cover;border-radius:8px">
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary">Guardar</button>
          <a class="btn btn-outline-secondary" th:href="@{/admin/producto/listado}">Cancelar</a>
        </div>
      </form>
    </section>

  </body>
</html>
